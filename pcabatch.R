help##### pcabatch.R  --- an R program to plot developmental and experimental samples of gene expression#####                 by first and second principle components### Edit the path to the data before using!# Change the path inside quotes in the `setwd' function to point at the data folder.### Data Assumptions:# Base data are gene expressions for samples reflecting the natural sequence.# New data are expressions of the same genes under experimental conditions.# The program will plot the base data by first and second principle components,# then plot the new samples.# Both base and new data are assumed to be in comma-separated (.csv) files,# with gene names in the first column, and sample names in the first row.# The top-row first-column position is empty.# The base data filename is assumed to be "base.csv".# The program will ask you to navigate to the file with the new data.# csv format is convenient, as clicking the file will bring it up in # excel (windows) or numbers (Mac) for easy inspection, etc.# Other formats can be accomodated by changing the 'sep' argument to 'read.table' in the program.### Using the program#  1.  Put the progam (pcabatch.R) and data files (bse.csv, new.csv) in the same folder.#  2.  Start R#  3.  Change the working directory to the folder that holds the data:#         One way is to use the R pull-down menu ('Misc' on MAC, 'File' on Windows)#         Another way is to type in the R window something like setwd("~/myfolder/subfolder") #         or maybe setwd("/Volumes/Users/Jonas/subfolder") #  4.  Start the program:#         Either use the File/Source File... pull-down menu and choose the file pcabatch.R#         or just type source("pcabatch.R")##### The Program Starts Here ########## We now assume you've already set the working directory via menus.# Report the working directory.cat("\nThe working directory:  ")print(getwd())### We assume base.csv is the name of the base data file.base <- read.table("base.csv", header=TRUE, row.names=1, sep=";")# Report the dimensions.cat("\nDimensions of base data:\n")print(dim(base))# This just gives you a chance to read that it's the new data file we want.readline("Press enter, then choose file with new data.")newflname <- file.choose(new = FALSE)                           ### Get the file name,new <- read.table(newflname, header=TRUE, row.names=1, sep=";") ### then the actual data.# Report the file name and dimensions of data.cat("\nNew data file:  ",newflname,"\n")cat("\nDimensions of new data:\n")print(dim(base))# Merge the base and new data, making sure the gene names match.all <- merge(base, new, by="row.names")# Fix the way merge handles row names.row.names(all) <- all$Row.names  ### merging tuns row names into a regular variable -- put them back.all <- all[,-1]                  ### and get rid of the extra row name variable in position 1.# Report dimensions of merged datacat("\nDimensions of merged data:\n")print(dim(all))# The gene names in the two files have to match, or else.if (nrow(base) != nrow(all)) print("Error!  The merge by gene names went wrong.")cat("\n\nSmallest non-zero number = ", min(all[all>0],na.rm=TRUE),"\n")tiny = 0.01cat(tiny, "will be added to permit taking logarithms\n\n")# take logarithmsdfl = log(all + tiny)dfl.base <- dfl[,1:ncol(base)]dfl.new <- dfl[,(ncol(base)+1):ncol(dfl)]cat("\nThe expression of all genes is plotted for each sample, on a log scale,\n")cat("before any normalization of gene expression.\n")cat("Five genes are traced across samples, just as examples of patterns.\n")# Draw boxplots, and add some gray lines to enclose replicates, and a raw-scale axis.boxplot(dfl, names=1:ncol(dfl))    abline(v=c(0,2,4,7,9,11)+0.5, col="light gray")axis(side=4,at=log(c(tiny,1,10,100,1000)),labels=c("0","1","10","100","1000"))title(main="Log expression of all genes for each sample\n w/o standardization")# Add traces for five genes.m = apply(dfl[,1:ncol(base)],1,max,na.rm=TRUE)m = dfl[,ncol(base)]qtiles = order(m)[seq(from=1,to=nrow(base),length=5)]for (i in qtiles) lines(1:ncol(dfl), as.matrix(dfl)[i,], col="gray")print(as.matrix(names(dfl)))readline("Press enter to continue.")# Use base data means to center genes in both base and new datasetsgene.means <- apply(dfl.base,1,mean)dfl.base.c <- sweep(dfl.base, 1, gene.means, "-")dfl.new.c <- sweep(dfl.new, 1, gene.means, "-")# do PCA using base datapca.base.c <- prcomp(t(dfl.base.c), scale=FALSE, center=FALSE, retx=TRUE, cor=TRUE)screeplot(pca.base.c, npcs=10, type="barplot")print(summary(pca.base.c))readline("Press enter to continue.")eigenvectors <- as.data.frame(pca.base.c$rotation)loadings.new <- t(as.matrix(dfl.new.c)) %*% as.matrix(eigenvectors)loadings.new <- as.data.frame(loadings.new)loadings.base <- t(as.matrix(dfl.base.c)) %*% as.matrix(eigenvectors)loadings.base <- as.data.frame(loadings.base)loadings.all <- rbind(loadings.base, loadings.new)plot(PC2 ~ PC1, data = loadings.all, type='p', pch=16,     col=rep(c("black","red"),c(ncol(base),ncol(new))))text(loadings.base$PC1, loadings.base$PC2+0.2, row.names(loadings.base),cex=0.5,col="gray")text(loadings.new$PC1, loadings.new$PC2+0.2, as.character(1:nrow(loadings.new)),cex=0.75)cat("\n\nKey to plotting numbers:\n")print(cbind(1:nrow(loadings.new), as.matrix(row.names(loadings.new))))